name: Build Application

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r insight_bot/requirements.txt
        pip install pyinstaller

    # --- Windows Specific (Use MSYS2 for reliable Opus) ---
    - name: Install Opus (Windows via MSYS2)
      if: runner.os == 'Windows'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        install: mingw-w64-x86_64-opus
        path-type: strict

    - name: Prepare Opus DLL (Windows)
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        # Copy from MSYS2-native path to workspace
        cp /mingw64/bin/libopus-0.dll ./libopus.dll
        ls -l libopus.dll

    - name: Build with PyInstaller (Windows)
      if: runner.os == 'Windows'
      run: |
        # Windows: Onefile is fine and preferred for single exe distribution
        pyinstaller --noconfirm --clean --onefile --windowed --name "InsightDebateBot" --add-binary "libopus.dll;." main.py

    # --- macOS Specific (Onedir for .app bundle) ---
    - name: Install Opus (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install opus
        OPUS_PATH=$(brew --prefix opus)/lib/libopus.dylib
        cp "$OPUS_PATH" ./libopus.dylib

    - name: Build with PyInstaller (macOS)
      if: runner.os == 'macOS'
      run: |
        # macOS: Use --onedir for valid .app bundle structure
        pyinstaller --noconfirm --clean --onedir --windowed --name "InsightDebateBot" --add-binary "libopus.dylib:." main.py

    # --- Artifact Upload ---
    - name: Upload Artifact (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: InsightDebateBot-Windows
        path: dist/InsightDebateBot.exe

    - name: Upload Artifact (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: InsightDebateBot-macOS
        path: dist/InsightDebateBot.app
